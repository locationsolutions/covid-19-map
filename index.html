<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Koronakartta</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
</head>

<body>
    <div><svg id="map">
        <g class="districts"></g>
        <g class="centers"></g>
    </svg></div>
    <script>

        function transform (data, before = '3000') {
            const cases = new Map();
            const districts = new Map();

            const filteredConfirmed = data.confirmed.filter(c => c.date < before);
            
            filteredConfirmed.forEach(c => {
                cases.set(Number(c.id), c);


                let val = districts.get(c.healthCareDistrict);
                if (!val) {
                    val = {
                        id: c.healthCareDistrict,
                        cases: []
                    }
                }
                val.cases.push(c);
                districts.set(c.healthCareDistrict, val);
            });
            const edges = new Map();
            filteredConfirmed
                .filter(c => typeof c.infectionSource === 'number')
                .forEach(c => {
                    const key = cases.get(c.infectionSource).healthCareDistrict + '%%' + c.healthCareDistrict;
                    let val = edges.get(key);
                    if (!val) {
                        val = 0;
                    }
                    val++;
                    edges.set(key, val);
                });

            return {
                cases,
                districts,
                edges
            }
        }

        const width = 960;
        const height = 500;
        
        const svg = d3.select("svg#map")
            .attr('width', width)
            .attr('height', height);
        
        const projection = d3.geoMercator()
        .scale(1100)
        .center([24, 65.5])
        .translate([width / 2, height / 2]);

        const path = d3.geoPath().projection(projection);
        
        Promise.all([
            fetch('https://vectiles.s3.eu-central-1.amazonaws.com/sairaanhoitopiiri.topojson.json').then(r => r.json()),
            fetch('https://w3qa5ydb4l.execute-api.eu-west-1.amazonaws.com/prod/finnishCoronaData').then(r => r.json())
        ]).then(responses => {
            const topo = responses[0];
            const corona = responses[1];

            const timeExtent = d3.extent(corona.confirmed.map(c => c.date));
            const allTime = transform(corona);

            const circleScale = d3.scalePow().exponent(0.5)
                .domain([0, d3.max(Array.from(allTime.districts.values()), d => d.cases.length)])
                .range([0, 20]);

            function update(time) {
                const vis = transform(corona, time);
                
                const f = topojson.feature(topo, topo.objects.sairaanhoitopiiri);
                f.features.forEach(f => {
                    f.properties.center = [f.properties.X_COORD, f.properties.Y_COORD];
                    const district = vis.districts.get(f.properties.json_shp_nimi);
                    if (district) {
                        district.feature = f;
                    }
                });

                const coronaDistricts = Array.from(vis.districts.values());

                svg.select('g.centers')
                .selectAll("circle")
                .data(coronaDistricts)
                    .enter().append("circle")
                    .attr("cx", d => projection(d.feature.properties.center)[0])
                    .attr("cy", d => projection(d.feature.properties.center)[1])
                    .attr("r", d => circleScale(d.cases.length));


                svg.select('g.districts')
                .selectAll("path")
                .data(f.features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("fill", '#500');
            }

            update('2020-03-05T09:00:00.000Z');
        });



    </script>
</body>

</html>